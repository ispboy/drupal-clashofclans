<?php

/**
 * @file
 * Provides a clan entity type.
 */

use Drupal\Core\Render\Element;
use Drupal\clashofclans_clan\Clan;

/**
 * Implements hook_theme().
 */
function clashofclans_clan_theme() {
  return [
    'clashofclans_clan' => [
      'render element' => 'elements',
    ],
  ];
}

/**
 * Prepares variables for clan templates.
 *
 * Default template: clashofclans-clan.html.twig.
 *
 * @param array $variables
 *   An associative array containing:
 *   - elements: An associative array containing the clan information and any
 *     fields attached to the entity.
 *   - attributes: HTML attributes for the containing element.
 */
function template_preprocess_clashofclans_clan(array &$variables) {
  foreach (Element::children($variables['elements']) as $key) {
    if ($key == 'field_data' && isset($variables['elements'][$key][0]['#context']['value'])) {
      // $weight = $variables['elements'][$key]['#weight'];
      $json = $variables['elements'][$key][0]['#context']['value'];
      if ($json) {
        $data = \Drupal\Component\Serialization\Json::decode($json);
        unset($data['tag']);
        unset($data['name']);
        unset($data['description']);
        $items = [];
        foreach ($data as $key => $item) {
          $renderable = [
            '#theme' => 'clashofclans_api__'. $key,
            '#data' => $item,
          ];

          $items[$key] = $renderable;
        }
        $variables['data'] = $items;
      }
      unset($variables['elements'][$key]);
    } else {
      $variables['content'][$key] = $variables['elements'][$key];
    }
  }
  $variables['content']['#cache']['max-age'] = 180;
}

function clashofclans_clan_entity_prepare_view($entity_type_id, array $entities, array $displays, $view_mode) {

  // Load a specific node into the user object for later theming.
  if (!empty($entities) && $entity_type_id == 'clashofclans_clan' && $view_mode == 'full') {
    $clan = \Drupal::service('clashofclans_clan.clan');
    foreach ($entities as $entity) {
      $clan->prepareView($entity);
    }
  }
}
